---
title: Firearm Legislation and Fatal Police Shootings in the US
output: 
    html_document:
        theme: cosmo 
        toc: true
        toc_float: true
        highlight: tango
        number_sections: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Motivation
Here we will recreate a study completed by the American Journal of Public Health "to examine whether stricter firearm legislation is associated with rates of fatal police shootings." https://ajph.aphapublications.org/doi/suppl/10.2105/AJPH.2017.303770

# What is the data?
This study uses data from several different sources.

1. The Brady Campain State Scorecard from 2015. This provides numerical scores for each state across different types of firearm legislation. Obtained at http://crimadvisor.com/data/Brady-State-Scorecard-2015.pdf.
2. The Counted: People killed by police in the US. Because "the US government has no comprehensive record of the number of people killed by law enforcement," The Counted project started and is known as a more accurate source for this data. https://www.theguardian.com/us-news/ng-interactive/2015/jun/01/about-the-counted.
3. Sociodemographic data, such as age, race, gender, and total population by state obtained from the US Census.https://www.census.gov/content/census/en/data/tables/2017/demo/popest/state-detail.html.
4. Violent crime data in 2015 by state.Obtained from the FBI's Uniform crime report https://ucr.fbi.gov/crime-in-the-u.s/2015/crime-in-the-u.s.-2015/tables/table-5.

# Data import
```{r}
library(readxl)
#census data
census <- read.csv("sc-est2017-alldata6.csv",nrows = 236900,stringsAsFactors = FALSE)
head(census)
# Brady scores
brady <- read_excel("Brady-State-Scorecard-2015.xlsx", sheet = 1)
head(brady)
# The Counted data
counted15 <- read.csv("the-counted-2015.csv",stringsAsFactors = FALSE)
counted16 <- read.csv("the-counted-2016.csv",stringsAsFactors = FALSE)
head(counted15)
# Crime data
crime <- read_excel("table_5_crime_in_the_united_states_by_state_2015.xls", sheet = 1,skip = 3)
head(crime)
```


# Data wrangling
## 1. Census Data
We need to find "age; percentage of study population that was male, White, Black, Hispanic, unemployed, and college educated; and population density at the state level" using the census data.

The following is taken from the document sc-est2017-alldata6.pdf:

  * The key for SEX is as follows:
    + 0 = Total
    + 1 = Male
    + 2 = Female

  * The key for ORIGIN is as follows: 
    + 0 = Total
    + 1 = Not Hispanic
    + 2 = Hispanic

  * The key for RACE is as follows:
    + 1 = White Alone
    + 2 = Black or African American Alone
    + 3 = American Indian and Alaska Native Alone
    + 4 = Asian Alone
    + 5 = Native Hawaiian and Other Pacific Islander Alone 6 = Two or more races

So we need to group the data in several different ways and calculate the necessary statistics.
Let's start with "percentage of the study population that was male." For each state, we need to add every row of data that is "male" (SEX = 1) in the column POPESTIMATE2015 since we are looking at the year 2015.
```{r}
library(dplyr)
maleStats <- census %>%
  filter(ORIGIN == 0) %>% #set origin to "Total" so we don't have repeats in the data.
  group_by(NAME) %>% #group by the state
  summarize(percentMale = sum(POPESTIMATE2015[SEX==1])/sum(POPESTIMATE2015[SEX==0])*100) #divide total male by total  population
head(maleStats)
```
Next let's tackle age. We need to find the median age for each state. This is tricky, since we don't have a list of ages (i.e., (22,55,4,27,35)) but instead we have the counts of the age. First we need to get the total counts for each age (per state), since that's divided up into all the other categories.
```{r}
library(dplyr)
library(tidyr)
library(data.table)
ageStats <- census %>%
  filter(ORIGIN == 0,SEX == 0) %>% #set origin and sex to "Total" so we don't have repeats in the data.
  group_by(NAME,AGE) %>% #group by state and age
  summarize(sumAges = sum(POPESTIMATE2015)) #divide total male by total  population
#ageStats$cumulative = cumsum(ageStats$sumAges)
head(ageStats)
ageStats <- dcast(setDT(ageStats), AGE ~ NAME, value.var="sumAges")
ageStats$AGE <- NULL
ageStats <- apply(ageStats, 2, cumsum)
ageStats <- as.data.frame(ageStats)
ageStats <- apply(ageStats,2,function(x) x/x[86])
ageStats <- as.data.frame(ageStats)
# now we have a percentile associated with each age
# (use the index minus 1 as the age)
# now we just need to get the age of the 50th percentile for each state...
head(ageStats)
median <- apply(ageStats,2,function(x) which.max(x > 0.5))
(medians <- as.data.frame(median))

```
Find the proportion of White, Black, and Hispanic residents per state.
```{r}
library(dplyr)
raceStats <- census %>%
  filter(ORIGIN == 0, SEX == 0) %>% #set origin and sex to "Total" so we don't have repeats in the data.
  group_by(NAME) %>% #group by the state
  summarize(percentWhite = sum(POPESTIMATE2015[RACE==1])/sum(POPESTIMATE2015)*100,
            percentBlack = sum(POPESTIMATE2015[RACE==2])/sum(POPESTIMATE2015)*100) 
head(raceStats)

originStats <- census %>%
  filter(SEX == 0) %>% #set origin and sex to "Total" so we don't have repeats in the data.
  group_by(NAME) %>% #group by the state
  summarize(percentHispanic = sum(POPESTIMATE2015[ORIGIN==2])/sum(POPESTIMATE2015[ORIGIN==0])*100)
head(originStats)
```
## 2. Violent Crime
```{r}
library(dplyr)
library(zoo)
head(crime)
# Selecting "Violent crime1" was not working, so I printed "colnames(crime)" to see that there are some extraneous characters in the names. Instead I take the index from the column names. I also could probably just select the index of the columns.
violentcrime<- crime %>%
  select("State",colnames(crime)[3], colnames(crime)[5]) 
violentcrime[10:20,] 
violentcrime2<- violentcrime %>%
  group_by(State) %>% 
  na.locf %>%
  ungroup
violentcrime2[10:20,] 
# Hmm..I don't want to fill na for the other columns just yet because now there are duplicate rows with different states, making it confusing.
# Let's do a quick fix
violentcrime$State <- violentcrime2$State
violentcrime[10:20,]
# I really want the "Rate per 100,000 inhabitants" for violent crime for each state.
violentcrime<- subset(violentcrime, X__1 == "Rate per 100,000 inhabitants")
violentcrime$X__1 <- NULL
names(violentcrime) <- c("State", "Violent_Crime_rate_per_100,000")
head(violentcrime)
```

## 3. Brady Scores
## 4. The Counted Fatal Shootings
# Exploratory data analysis

# Data analysis

# Summary of results


